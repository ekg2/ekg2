<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-2" />
<style type="text/css">
BODY { font-family: tahoma, verdana, arial, helvetica, sans-serif; }
.tab { background-color: #a0a0a0; }
.tabh { background-color: #d0d0d0; }
.tabf { background-color: white; }
.c { font-family: monospace; padding: 0.7em; background-color: #e0e0e0; border: 1px solid #a0a0a0; }
.http { font-family: monospace; padding: 0.7em; background-color: #c0f0c0; border: 1px solid #80a080; }
.example { font-family: monospace; padding: 0.7em; background-color: #c0f0f0; border: 1px solid #80a0a0; }
PRE { margin: 0px; }
H1, H2, H3 { margin-top: 0px; }
</style>
<title>Protokó³ Gadu-Gadu</title>
</head>

<body bgcolor="white" text="black">

<center>
<table width="600" border="0"><tr><td>

<center>
<h1>Protokó³ Gadu-Gadu</h1>
<h3>&copy; Copyright 2001 - 2003 <a href="#ch4">Autorzy</a></h3>
</center>

<hr />

<a name="index"></a>

<h2>Spis tre¶ci</h2>

<ol>
	<li><a href="#ch1">Protokó³ Gadu-Gadu</a><br />
		1.1.&nbsp;&nbsp;<a href="#ch1.1">Format pakietów</a><br />
		1.2.&nbsp;&nbsp;<a href="#ch1.2">Zanim siê po³±czymy</a><br />
		1.3.&nbsp;&nbsp;<a href="#ch1.3">Logowanie siê</a><br />
		1.4.&nbsp;&nbsp;<a href="#ch1.4">Zmiana stanu</a><br />
		1.5.&nbsp;&nbsp;<a href="#ch1.5">Ludzie przychodz±, ludzie odchodz±</a><br />
		1.6.&nbsp;&nbsp;<a href="#ch1.6">Wysy³anie wiadomo¶ci</a><br />
		1.7.&nbsp;&nbsp;<a href="#ch1.7">Otrzymywanie wiadomo¶ci</a><br />
		1.8.&nbsp;&nbsp;<a href="#ch1.8">Ping, pong</a><br />
		1.9.&nbsp;&nbsp;<a href="#ch1.9">Roz³±czenie</a><br />
		1.10.&nbsp;&nbsp;<a href="#ch1.10">Katalog publiczny</a><br />
	</li>
	<li><a href="#ch2">Us³ugi HTTP</a><br />
		2.1.&nbsp;&nbsp;<a href="#ch2.1">Format danych</a><br />
		2.2.&nbsp;&nbsp;<a href="#ch2.2">Rejestracja konta</a><br />
		2.3.&nbsp;&nbsp;<a href="#ch2.3">Usuniêcie konta</a><br />
		2.4.&nbsp;&nbsp;<a href="#ch2.4">Zmiana has³a</a><br />
		2.5.&nbsp;&nbsp;<a href="#ch2.5">Umieszczenie listy kontaktów na serwerze</a><br />
		2.6.&nbsp;&nbsp;<a href="#ch2.6">Pobranie listy kontaktów z serwera</a><br />
		2.7.&nbsp;&nbsp;<a href="#ch2.7">Usuniêcie listy kontaktów z serwera</a><br />
		2.8.&nbsp;&nbsp;<a href="#ch2.8">Przypomnienie has³a poczt±</a><br />
	</li>
	<li><a href="#ch3">Bezpo¶rednie po³±czenia</a></li>
	<li><a href="#ch4">Autorzy</a></li>
</ol>

<hr />

<a name="ch0"></a>
<h2>Informacje wstêpne</h2>

<p>
Opis protoko³u u¿ywanego przez Gadu-Gadu bazuje na do¶wiadczeniach
przeprowadzonych przez autorów oraz informacjach nadsy³anych przez 
u¿ytkowników. ¯aden klient Gadu-Gadu nie zosta³ skrzywdzony podczas
badañ. Reverse-engineering opiera³ siê g³ównie na analizie pakietów
przesy³anych miêdzy klientem a serwerem.
</p>

<p>
Najnowsza wersja opisu protoko³u znajduje siê pod adresem
<a href="http://dev.null.pl/ekg/docs/protocol.html">http://dev.null.pl/ekg/docs/protocol.html</a>.
</p>

<hr />

<a name="ch1"></a>
<h2>1. Protokó³ Gadu-Gadu</h2>

<a name="ch1.1"></a>
<h3>1.1. Format pakietów</h3>

<p>
Podobnie jak coraz wiêksza ilo¶æ komunikatorów, Gadu-Gadu korzysta z
protoko³u TCP/IP. Ka¿dy pakiet zawiera na pocz±tku dwa sta³e pola:
</p>

<div class="c">
<pre>struct gg_header {
	int type;	<i>/* typ pakietu */</i>
	int length;	<i>/* d³ugo¶æ reszty pakietu */</i>
};</pre>
</div>

<p>
Wszystkie zmienne liczbowe s± zgodne z kolejno¶ci± bajtów maszyn Intela,
czyli Little-Endian.
</p>

<p>
Przy opisie struktur, za³o¿ono, ¿e <tt>char</tt> ma rozmiar 1 bajtu,
<tt>short</tt> 2 bajtów, <tt>int</tt> 4 bajtów. U¿ywaj±c innych
architektur ni¿ i386 nale¿y zwróciæ szczególn± uwagê na rozmiar typów
zmiennych i kolejno¶æ znaków.
</p>

<p>
Pola, który znaczenie jest nieznane, lub nie do koñca jasne, oznaczono
przedrostkiem <tt>unknown</tt>.
</p>

<hr />

<a name="ch1.2"></a>
<h3>1.2. Zanim siê po³±czymy</h3>

<p>
¯eby wiedzieæ, z jakim serwerem mamy siê po³±czyæ, nale¿y poudawaæ przez
chwilê przegl±darkê WWW i po³±czyæ siê z hostem <tt>appmsg.gadu-gadu.pl</tt>.
</p>

<div class="http">
<pre>GET /appsvc/appmsg.asp?fmnumber=<b>NUMER</b> HTTP/1.0
Host: appmsg.gadu-gadu.pl
User-Agent: Mozilla/4.7 [en] (Win98; I)
Pragma: no-cache</pre>
</div>

<p>
Oryginalny klient mo¿e wys³aæ jeden z podanych identyfikatorów przegl±darki:
</p>

<ul>
<li><tt>Mozilla/4.04 [en] (Win95; I ;Nav)</tt></li>
<li><tt>Mozilla/4.7 [en] (Win98; I)</tt></li>
<li><tt>Mozilla/4.0 (compatible; MSIE 5.0; Windows NT; DigExt)</tt></li>
<li><tt>Mozilla/4.0 (compatible; MSIE 5.0; Windows NT)</tt></li>
<li><tt>Mozilla/4.0 (compatible; MSIE 5.0; Windows 98; DigExt)</tt></li>
<li><tt>Mozilla/4.0 (compatible; MSIE 5.0; Windows 98)</tt></li>
</ul>

<p>
Nowsze wersje (od 4.6.2) korzystaj± z innego skryptu:
</p>

<div class="http">
<pre>GET /appsvc/appmsg2.asp?fmnumber=<b>NUMER</b>&amp;version=<b>WERSJA</b>&amp;fmt=<b>FORMAT</b>&amp;lastmsg=<b>WIADOMO¦Æ</b>
Host: appmsg.gadu-gadu.pl
User-Agent: <b>PRZEGL¡DARKA</b>
Pragma: no-cache</pre>
</div>

<p>
Gdzie <b>NUMER</b> jest numerem klienta, <b>WERSJA</b> jest wersj± klienta
postaci ,,<tt>A, B, C, D</tt>'' (na przyk³ad ,,<tt>5, 0, 5, 107</tt>'' dla
wersji 5.0.5 buildu 107),
<b>FORMAT</b> okre¶la czy wiadomo¶æ systemowa bêdzie przesy³ana czystym
tekstem (brak zmiennej "fmt") czy w HTMLu (jakakolwiek jej warto¶æ), a
<b>WIADOMO¦Æ</b> jest numerem ostatnio otrzymanej wiadomo¶ci systemowej.
Na postawione w ten sposób zapytanie, serwer powinien odpowiedzieæ
na przyk³ad tak:
</p>

<div class="http">
<pre>HTTP/1.0 200 OK

0 217.17.41.84:8074 217.17.41.84</pre>
</div>

<p>
Pierwsze pole jest numerem wiadomo¶ci systemowej, a drugie i trzecie
podaj± nam namiary na w³a¶ciwy serwer. Je¶li serwer jest niedostêpny,
zamiast adresu IP jest zwracany tekst ,,<tt>notoperating</tt>''.
Je¿eli po³±czenie z portem 8074 nie powiedzie siê z jakich¶ powodów,
mo¿na siê ³±czyæ na port 443. 
</p>

<p>
Je¶li pierwsza liczba nie jest równa zero, zaraz po nag³ówku znajduje siê
wiadomo¶æ systemowa, lub je¶li linia zaczyna siê od znaku ,,<tt>@</tt>'',
adres strony, któr± nale¿y otworzyæ w przegl±darce.
</p>

<hr />

<a name="ch1.3"></a>
<h3>1.3. Logowanie siê</h3>

<p>
Po po³±czeniu siê portem 8074 lub 443 serwera Gadu-Gadu, dostajemy pakiet
typu <tt>0x0001</tt>, który na potrzeby tego dokumentu nazwiemy:
</p>

<div class="c">
<pre>#define GG_WELCOME 0x0001</pre>
</div>

<p>
Reszta pakietu zawiera liczbê, na podstawie której liczony jest hash z has³a
klienta:
</p>

<div class="c">
<pre>struct gg_welcome {
	int seed;	<i>/* klucz szyfrowania has³a */</i>
};</pre>
</div>

<p>
Kiedy mamy ju¿ t± warto¶æ mo¿emy odes³aæ pakiet logowania
</p>

<div class="c">
<pre>#define GG_LOGIN 0x000c</pre>
</div>

<p>
Musimy podaæ kilka informacji:
</p>

<div class="c">
<pre>struct gg_login {
	int uin;		<i>/* numer klienta */</i>
	int hash;		<i>/* hash has³a */</i>
	int status;		<i>/* pocz±tkowy stan */</i>
	int version;		<i>/* wersja klienta */</i>
	int local_ip;		<i>/* mój adres ip */</i>
	short local_port;	<i>/* port, na którym s³ucham */</i>
	char description[];	<i>/* opis, nie musi wyst±piæ */</i>
	int time;		<i>/* czas, nie musi wyst±piæ */</i>
};</pre>
</div>

<p>
Hash has³a w pierwszych wersjach by³ liczony w do¶æ prosty sposób, ale
niestety z któr±¶ zmian± protoko³u wprowadzono nowy algorytm:
</p>

<div class="example">
<pre>int gg_login_hash(char *password, int seed)
{
	unsigned int x, y, z;

	y = seed;

	for (x = 0; *password; password++) {
		x = (x &amp; 0xffffff00) | *password;
		y ^= x;
		y += x;
		x &lt;&lt;= 8;
		y ^= x;
		x &lt;&lt;= 8;
		y -= x;
		x &lt;&lt;= 8;
		y ^= x;

		z = y &amp; 0x1f;
		y = (y &lt;&lt; z) | (y &gt;&gt; (32 - z));
	}

	return y;
}</pre>
</div>

<p>
Liczba oznaczaj±ca wersjê mo¿e byæ jedn± z poni¿szych:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Warto¶æ</b></td><td><b>Wersje klientów</b></td></tr>
<tr class="tabf"><td><tt>0x1b</tt></td><td>5.0.5</td></tr>
<tr class="tabf"><td><tt>0x19</tt></td><td>5.0.3</td></tr>
<tr class="tabf"><td><tt>0x18</tt></td><td>5.0.1, 5.0.0, 4.9.3</td></tr>
<tr class="tabf"><td><tt>0x17</tt></td><td>4.9.2</td></tr>
<tr class="tabf"><td><tt>0x16</tt></td><td>4.9.1</td></tr>
<tr class="tabf"><td><tt>0x15</tt></td><td>4.8.9</td></tr>
<tr class="tabf"><td><tt>0x14</tt></td><td>4.8.3, 4.8.1</td></tr>
<tr class="tabf"><td><tt>0x11</tt></td><td>4.6.10, 4.6.1</td></tr>
<tr class="tabf"><td><tt>0x10</tt></td><td>4.5.22, 4.5.21, 4.5.19, 4.5.17, 4.5.15</td></tr>
<tr class="tabf"><td><tt>0x0f</tt></td><td>4.5.12</td></tr>
<tr class="tabf"><td><tt>0x0b</tt></td><td>4.0.30, 4.0.29, 4.0.28, 4.0.25</td></tr>
</table>

<p>
Oczywi¶cie nie s± to wszystkie mo¿liwe wersje klientów, lecz te, które
uda³o siê z³apaæ na wolno¶ci. Najbezpieczniej bêdzie przedstawiaæ siê jako
ta wersja, której w³asno¶ci u¿ywamy. Wiadomo, ¿e wersje 4.0 nie obs³ugiwa³y
trybu ukrytego, tylko dla znajomych itd.
</p>

<p>
W najnowszej wersji protoko³u jest dodatkowa maska na wersjê:
</p>

<div class="c">
<pre>#define GG_HAS_AUDIO_MASK 0x40000000</pre>
</div>

<p>
która mówi nam, ¿e dany klient mo¿e prowadziæ rozmowy g³osowe.
</p>

<p>
Je¶li wszystko siê powiedzie, dostaniemy w odpowiedzi pakiet typu:
</p>

<div class="c">
<pre>#define GG_LOGIN_OK 0x0003</pre>
</div>

<p>
o zerowej d³ugo¶ci, lub w przypadku b³êdu pakiet:
</p>

<div class="c">
<pre>#define GG_LOGIN_FAILED 0x0009</pre>
</div>

<p>
Od wersji 4.9.3 (protokó³ 0x18), mo¿liwe jest równie¿ wykorzystanie
przekierowania portów. Je¶li chcemy wykorzystaæ, nale¿y zamiast
pakietu GG_LOGIN wys³aæ nastêpuj±cy:
</p>

<div class="c">
<pre>#define GG_LOGIN_EXT 0x0013

struct gg_login_ext {
	int uin;		<i>/* numer klienta */</i>
	int hash;		<i>/* hash has³a */</i>
	int status;		<i>/* pocz±tkowy stan */</i>
	int version;		<i>/* wersja klienta */</i>
	int local_ip;		<i>/* mój adres ip */</i>
	short local_port;	<i>/* port, na którym s³ucham */</i>
	int external_ip;	<i>/* zewnêtrzny adres ip */</i>
	short external_port;	<i>/* zewnêtrzny port */</i>
	char description[];	<i>/* opis, nie musi wyst±piæ */</i>
	int time;		<i>/* czas, nie musi wyst±piæ */</i>
};</pre>
</div>

<hr />

<a name="ch1.4"></a>
<h3>1.4. Zmiana stanu</h3>

<p>
Gadu-Gadu przewiduje kilka stanów klienta, które zmieniamy pakietem typu:
</p>

<div class="c">
<pre>#define GG_NEW_STATUS 0x0002
	
struct gg_new_status {
	int status;		<i>/* na jaki zmieniæ? */</i>
	char description[];	<i>/* opis, nie musi wyst±piæ */</i>
	int time;		<i>/* czas, nie musi wyst±piæ */</i>
}</pre>
</div>

<p>
Mo¿liwe stany to:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_STATUS_NOT_AVAIL</tt></td><td><tt>0x0001</tt></td><td>Niedostêpny</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_NOT_AVAIL_DESCR</tt></td><td><tt>0x0015</tt></td><td>Niedostêpny (z opisem)</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_AVAIL</tt></td><td><tt>0x0002</tt></td><td>Dostêpny</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_AVAIL_DESCR</tt></td><td><tt>0x0004</tt></td><td>Dostêpny (z opisem)</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_BUSY</tt></td><td><tt>0x0003</tt></td><td>Zajêty</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_BUSY_DESCR</tt></td><td><tt>0x0005</tt></td><td>Zajêty (z opisem)</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_INVISIBLE</tt></td><td><tt>0x0014</tt></td><td>Niewidoczny</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_INVISIBLE_DESCR</tt></td><td><tt>0x0016</tt></td><td>Niewidoczny z opisem</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_BLOCKED</tt></td><td><tt>0x0006</tt></td><td>Zablokowany</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_FRIENDS_MASK</tt></td><td><tt>0x8000</tt></td><td>Maska bitowa oznaczaj±ca tryb tylko dla przyjació³</td></tr>
</table>

<p>
Nale¿y pamiêtaæ, ¿eby przed roz³±czeniem siê z serwerem nale¿y zmieniæ
stan na <tt>GG_STATUS_NOT_AVAIL</tt> lub <tt>GG_STATUS_NOT_AVAIL_DESCR</tt>.
Je¶li ma byæ widoczny tylko dla przyjació³, nale¿y dodaæ
<tt>GG_STATUS_FRIENDS_MASK</tt> do normalnej warto¶ci stanu.
</p>

<p>
Je¶li wybieramy stan opisowy, nale¿y do³±czyæ ci±g znaków zakoñczony
zerem oraz ewentualny czas powrotu w postaci ilo¶ci sekund od 1 stycznia
1970r (UTC). Maksymalna d³ugo¶æ opisu wynosi 70 znaków plus zero plus
4 bajty na godzinê powrotu, co razem daje 75 bajtów.
</p>

<hr />

<a name="ch1.5"></a>
<h3>1.5. Ludzie przychodz±, ludzie odchodz±</h3>

<p>
Zaraz po zalogowaniu mo¿emy wys³aæ serwerowi nasz± listê kontaktów, ¿eby
dowiedzieæ siê, czy s± w danej chwili dostêpni. Pakiet zawiera maksymalnie
409 struktur <tt>gg_notify</tt>:
</p>

<div class="c">
<pre>#define GG_NOTIFY 0x0010
	
struct gg_notify {
	int uin;	<i>/* numerek danej osoby */</i>
	char type;	<i>/* rodzaj u¿ytkownika */</i>
};</pre>	
</div>

<p>
Gdzie pole <tt>type</tt> przyjmuje nastêpuj±ce warto¶ci:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_USER_OFFLINE</tt></td><td><tt>0x01</tt></td><td>U¿ytkownik, dla którego bêdziemy niedostêpni</td></tr>
<tr class="tabf"><td><tt>GG_USER_NORMAL</tt></td><td><tt>0x03</tt></td><td>Zwyk³y u¿ytkownik dodany do listy kontaktów</td></tr>
<tr class="tabf"><td><tt>GG_USER_BLOCKED</tt></td><td><tt>0x04</tt></td><td>U¿ytkownik, którego wiadomo¶ci nie chcemy otrzymywaæ</td></tr>
</table>

<!-- Adam pisa³, ¿e jest to bitmapa, w której 0x01 znaczy otwarte okienko
rozmowy z dan± osob±, ale wygl±da³oby to co najmniej dziwnie, wiêc
upro¶ci³em trochê ca³± sprawê. -->

<p>
Je¶li nie mamy nikogo na li¶cie wysy³amy pakiet:
</p>

<div class="c">
<pre>#define GG_LIST_EMPTY 0x0012</pre>
</div>

<p>	
o zerowej d³ugo¶ci.
</p>

<p>
Je¶li kto¶ jest, serwer odpowie pakietem zawieraj±cym jedn± lub wiêcej
struktur <tt>gg_notify_reply</tt>:
</p>

<div class="c">
<pre>#define GG_NOTIFY_REPLY 0x000c	/* tak, to samo co GG_LOGIN */
	
struct gg_notify_reply {
	int uin;		/* numerek */
	int status;		/* status danej osoby */
	int remote_ip;		/* adres ip delikwenta */
	short remote_port;	/* port, na którym s³ucha klient */
	int version;		/* wersja klienta */
	short unknown1;		/* znowu port? */
	char description[];	/* opis, nie musi wyst±piæ */
	int time;		/* czas, nie musi wyst±piæ */
};</pre>
</div>

<p>
Wiêkszo¶æ pól powinna byæ zrozumia³a. <tt>remote_port</tt> poza zwyk³ym
portem mo¿e przyjmowaæ równie¿ poni¿sze warto¶ci:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td>0</td><td>Klient nie obs³uguje bezpo¶rednich po³±czeñ</td></tr>
<tr class="tabf"><td>1</td><td>Klient ³±czy siê zza NAT lub innej formy maskarady</td></tr>
<tr class="tabf"><td>2</td><td>Klient nie ma nas w swojej li¶cie kontaktów</td></tr>
</table>

<p>
Zdarzaj± siê te¿ inne ,,nietypowe'' warto¶ci, ale ich znaczenie nie jest
jeszcze do koñca znane.
</p>

<p>
Je¶li dany klient jest w stanie z podanym opisem, najpierw dostaniemy
informacjê osobnym pakietem o nim, pó¼niej paczkê struktur
<tt>gg_notify_reply</tt> z lud¼mi, którzy nie maj± ustawionych opisów.
</p>

<p>
Mo¿liwe jest równie¿ otrzymanie pakietu <tt>gg_notify_reply</tt> ze swoim w³asnym numerem, któr± najlepiej zignorowaæ.
</p>

<p>
¯eby dodaæ kogo¶ do listy w trakcie pracy, trzeba wys³aæ ni¿ej opisany
pakiet. Jego format jest identyczny jak przy <tt>GG_NOTIFY</tt>.
</p>

<div class="c">
<pre>#define GG_ADD_NOTIFY 0x000d
	
struct gg_add_notify {
	int uin;	<i>/* numerek */</i>
	char type;	<i>/* rodzaj u¿ytkownika */</i>
};</pre>
</div>

<p>
By usun±æ z listy kontaktów, wysy³a siê podobny pakiet:
</p>

<div class="c">
<pre>#define GG_REMOVE_NOTIFY 0x000e
	
struct gg_remove_notify {
	int uin;	<i>/* numerek */</i>
	char type;	<i>/* rodzaj u¿ytkownika */</i>
};</pre>
</div>

<p>
Je¶li kto¶ opu¶ci Gadu-Gadu lub zmieni stan na niedostêpny lub niewidoczny, otrzymamy pakiet:
</p>

<div class="c">
<pre>#define GG_STATUS 0x0002
	
struct gg_status {
	int uin;	        <i>/* numerek */</i>
	int status;	        <i>/* nowy stan */</i>
	char description[];	<i>/* opis, nie musi wyst±piæ */</i>
	int time;		<i>/* czas, nie musi wyst±piæ */</i>
};</pre>
</div>

<p>
Natomiast je¶li kto¶ zmieni status na inny ni¿ niedostêpny lub niewidoczny, otrzymamy pakiet <tt>gg_notify_reply</tt>.
</p>

<hr />

<a name="ch1.6"></a>
<h3>1.6. Wysy³anie wiadomo¶ci</h3>

<p>
Wiadomo¶ci wysy³a siê nastêpuj±cym typem pakietu:
</p>

<div class="c">
<pre>#define GG_SEND_MSG 0x000b

struct gg_send_msg {
	int recipient;		<i>/* numer odbiorcy */</i>
	int seq;		<i>/* numer sekwencyjny */</i>
	int class;		<i>/* klasa wiadomo¶ci */</i>
	char message[];		<i>/* tre¶æ */</i>
};</pre>
</div>

<p>
Numer sekwencyjny jest wykorzystywany przy potwierdzeniu dostarczenia
lub zakolejkowania pakietu. Nie jest wykluczone, ¿e w jaki¶ sposób odró¿nia
siê ró¿ne rozmowy za pomoc± czê¶ci bajtów, ale raczej nie powinno mieæ to
ma znaczenia. Klasa wiadomo¶ci pozwala odró¿niæ, czy wiadomo¶æ ma siê
pojawiæ w osobnym okienku czy jako kolejna linijka w okienku rozmowy. Jest
to mapa bitowa, wiêc najlepiej ignorowaæ te bity, których znaczenia nie
znamy:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_CLASS_QUEUED</tt></td><td><tt>0x0001</tt></td><td>Bit ustawiany wy³±cznie przy odbiorze wiadomo¶ci, gdy wiadomo¶æ zosta³a wcze¶niej zakolejkowania z powodu nieobecno¶ci</td></tr>
<tr class="tabf"><td><tt>GG_CLASS_MSG</tt></td><td><tt>0x0004</tt></td><td>Wiadomo¶æ ma siê pojawiæ w osobnym okienku</td></tr>
<tr class="tabf"><td><tt>GG_CLASS_CHAT</tt></td><td><tt>0x0008</tt></td><td>Wiadomo¶æ jest czê¶ci± tocz±cej siê rozmowy i zostanie wy¶wietlona w istniej±cym okienku</td></tr>
<tr class="tabf"><td><tt>GG_CLASS_CTCP</tt></td><td><tt>0x0010</tt></td><td>Wiadomo¶æ jest przeznaczona dla klienta Gadu-Gadu i nie powinna byæ wy¶wietlona u¿ytkownikowi.</td></tr>
<tr class="tabf"><td><tt>GG_CLASS_ACK</tt></td><td><tt>0x0020</tt></td><td>Klient nie ¿yczy sobie potwierdzenia wiadomo¶ci.</td></tr>
</table>

<p>
D³ugo¶æ tre¶ci wiadomo¶ci nie powinna przekraczaæ 2000 znaków. Oryginalny
klient zezwala na wys³anie do 1989 znaków.
</p>

<p>
Oryginalny klient wysy³aj±c wiadomo¶æ do kilku u¿ytkowników, wysy³a po
kilka takich samych pakietów z ró¿nymi numerkami odbiorców. Nie ma osobnego
pakietu do tego. Natomiast je¶li chodzi o <i>po³±czenia konferencyjne</i>
do pakietu doklejana jest nastêpuj±ca struktura:
</p>

<div class="c">
<pre>struct gg_msg_recipients {
	char flag;		<i>/* == 1 */</i>
	int count;		<i>/* ilo¶æ odbiorców */</i>
	int recipients[];	<i>/* tablica odbiorców */</i>
};</pre>
</div>

<p>
Na przyk³ad, by wys³aæ do dwóch osób, nale¿y wys³aæ pakiet:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Offset</b></td><td><b>Warto¶æ</b></td></tr>
<tr class="tabf"><td><i>n</i></td><td>Tre¶æ wiadomo¶ci</td></tr>
<tr class="tabf"><td><i>m</i></td><td><tt>0x01</tt> (wiadomo¶æ konferencyjna)</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;1</td><td rowspan="4"><tt>0x02</tt> (ilo¶æ adresatów)</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;2</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;3</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;4</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;5</td><td rowspan="4">Numer pierwszego adresata</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;6</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;7</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;8</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;9</td><td rowspan="4">Numer drugiego adresata</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;10</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;11</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;12</td></tr>
</table>

<p>
Od wersji 4.8.1 mo¿liwe jest równie¿ dodawanie do wiadomo¶ci ró¿nych
atrybutów tekstu jak pogrubienie czy kolory. Niezbêdne jest do³±czenie
nastêpuj±cej struktury:
</p>

<div class="c">
<pre>struct gg_msg_richtext {
	char flag;	<i>/* == 2 */</i>
	short length;	<i>/* d³ugo¶æ dalszej czê¶ci */</i>
};</pre>
</div>

<p>
Dalsza czê¶æ pakietu zawiera odpowiedni± ilo¶æ struktur o ³±cznej d³ugo¶ci
okre¶lonej polem <tt>length</tt>:
</p>

<div class="c">
<pre>struct gg_msg_richtext_format {
	short position;	<i>/* pozycja atrybutu w tek¶cie */</i>
	char font;	<i>/* atrybuty czcionki */</i>
	char rgb[3];	<i>/* kolor czcionki, nie musi wyst±piæ */</i>
};</pre>
</div>

<p>
Ka¿da z tych struktur okre¶la kawa³ek tekstu pocz±wszy od znaku okre¶lonego
przez pole <tt>position</tt> (liczone od zera) a¿ do nastêpnego wpisu lub
koñca tekstu. Pole <tt>font</tt> jest map± bitow± i kolejne bity maj±
nastêpuj±ce znaczenie:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_FONT_BOLD</tt></td><td><tt>0x01</tt></td><td>Pogrubiony tekst</td></tr>
<tr class="tabf"><td><tt>GG_FONT_ITALIC</tt></td><td><tt>0x02</tt></td><td>Kursywa</td></tr>
<tr class="tabf"><td><tt>GG_FONT_UNDERLINE</tt></td><td><tt>0x04</tt></td><td>Podkre¶lenie</td></tr>
<tr class="tabf"><td><tt>GG_FONT_COLOR</tt></td><td><tt>0x08</tt></td><td>Kolorowy tekst. Tylko w tym wypadku struktura <tt>gg_msg_richtext_format</tt> zawiera pole <tt>rgb[]</tt> bêd±ce opisem trzech sk³adowych koloru, kolejno czerwonej, zielonej i niebieskiej.</td></tr>
</table>

<p>
Dla przyk³adu, by przes³aæ tekst ,,ala <b>ma</b> kota'', nale¿y do³±czyæ do
wiadomo¶ci nastêpuj±c± sekwencjê bajtów:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Offset</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><i>n</i></td><td><tt>0x02</tt></td><td>Opis atrybutów tekstu...</td></tr>
<tr class="tabf"><td><i>n</i> + 1</td><td rowspan="2"><tt>0x0006</tt></td><td rowspan="2">...maj±cy 6 bajtów d³ugo¶ci</td></tr>
<tr class="tabf"><td><i>n</i> + 2</td></tr>
<tr class="tabf"><td><i>n</i> + 3</td><td rowspan="2"><tt>0x0004</tt></td><td rowspan="2">Atrybut zaczyna siê od pozycji 4...</td></tr>
<tr class="tabf"><td><i>n</i> + 4</td></tr>
<tr class="tabf"><td><i>n</i> + 5</td><td><tt>0x01</tt></td><td>...i jest to pogrubiony tekst</td></tr>
<tr class="tabf"><td><i>n</i> + 6</td><td rowspan="2"><tt>0x0006</tt></td><td rowspan="2">Atrybut zaczyna siê od pozycji 6...</td></tr>
<tr class="tabf"><td><i>n</i> + 7</td></tr>
<tr class="tabf"><td><i>n</i> + 8</td><td><tt>0x00</tt></td><td>...i jest to zwyk³y tekst</td></tr>
</table>

<p>
Serwer po otrzymaniu wiadomo¶ci odsy³a potwierdzenie, które przy okazji
mówi nam, czy wiadomo¶æ dotar³a do odbiorcy czy zosta³a zakolejkowana
z powodu nieobecno¶ci. Otrzymujemy je w postaci pakietu:
</p>

<div class="c">
<pre>#define GG_SEND_MSG_ACK 0x0005
	
struct gg_send_msg_ack {
	int status;	<i>/* stan wiadomo¶ci */</i>
	int recipient;	<i>/* numer odbiorcy */</i>
	int seq;	<i>/* numer sekwencyjny */</i>
};</pre>
</div>

<p>
Numer sekwencyjny i numer adresata s± takie same jak podczas wysy³ania,
a stan wiadomo¶ci mo¿e byæ jednym z nastêpuj±cych:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_ACK_DELIVERED</tt></td><td><tt>0x0002</tt></td><td>Wiadomo¶æ dostarczono</td></tr>
<tr class="tabf"><td><tt>GG_ACK_QUEUED</tt></td><td><tt>0x0003</tt></td><td>Wiadomo¶æ zakolejkowano</td></tr>
<tr class="tabf"><td><tt>GG_ACK_MBOXFULL</tt></td><td><tt>0x0004</tt></td><td>Wiadomo¶ci nie dostarczono. Skrzynka odbiorcza na serwerze jest pe³na (20 wiadomo¶ci maks). Wystêpuje tylko w trybie offline</td></tr>
<tr class="tabf"><td><tt>GG_ACK_NOT_DELIVERED</tt></td><td><tt>0x0006</tt></td><td>Wiadomo¶ci nie dostarczono. Odpowied¼ ta wystêpuje tylko w przypadku wiadomo¶ci klasy <tt>GG_CLASS_CTCP</tt></td></tr>
</table>

<hr />

<a name="ch1.7"></a>
<h3>1.7. Otrzymywanie wiadomo¶ci</h3>

<p>
Wiadomo¶ci serwer przysy³a za pomoc± pakietu:
</p>

<div class="c">
<pre>#define GG_RECV_MSG 0x000a
	
struct gg_recv_msg {
	int sender;		<i>/* numer nadawcy */</i>
	int seq;		<i>/* numer sekwencyjny */</i>
	int time;		<i>/* czas nadania */</i>
	int class;		<i>/* klasa wiadomo¶ci */</i>
	char message[];		<i>/* tre¶æ wiadomo¶ci */</i>
};</pre>
</div>

<p>
Czas nadania jest zapisany w postaci UTC, jako ilo¶ci sekund od 1 stycznie
1970r.
</p>

<p>
W przypadku pakietów ,,konferencyjnych'' na koñcu pakietu doklejona jest
struktura identyczna z <tt>gg_msg_recipients</tt> zawieraj±ca pozosta³ych
rozmówców.
</p>

<hr />

<a name="ch1.8"></a>
<h3>1.8. Ping, pong</h3>

<p>
Od czasu do czasu klient wysy³a pakiet do serwera, by oznajmiæ, ¿e po³±czenie
jeszcze jest utrzymywane. Je¶li serwer nie dostanie takiego pakietu w
przeci±gu 5 minut, zrywa po³±czenie. To, czy klient dostaje odpowied¼
zmienia siê z wersji na wersjê, wiêc najlepiej nie polegaæ na tym.
</p>

<div class="c">
<pre>#define GG_PING 0x0008

#define GG_PONG 0x0007</pre>
</div>

<hr />

<a name="ch1.9"></a>
<h3>1.9. Roz³±czenie</h3>

<p>
Je¶li serwer zechce nas roz³±czyæ, wy¶le wcze¶niej pusty pakiet:
</p>

<div class="c">
<pre>#define GG_DISCONNECTING 0x000b</pre>
</div>

<p>
Ma to miejsce, gdy próbowano zbyt wiele razy po³±czyæ siê z nieprawid³owym
has³em, lub gdy równocze¶nie po³±czy siê drugi klient z tym samym numerem
(nowe po³±czenie ma wy¿szy priorytet).
</p>

<hr />

<a name="ch1.10"></a>
<h3>1.10. Katalog publiczny</h3>

<p>
Od wersji 5.0.2 zmieniono sposób dostêpu do katalogu publicznego -- sta³
siê czê¶ci± sesji, zamiast osobnej sesji HTTP. Aby obs³ugiwaæ wyszukiwanie
osób, odczytywanie w³asnych informacji lub ich modyfikacjê nale¿y u¿yæ
nastêpuj±cego typu pakietu:
</p>

<div class="c">
<pre>#define GG_PUBDIR50_REQUEST 0x0014
	
struct gg_pubdir50 {
	char type;
	int seq;
	char request[];
};</pre>
</div>

<p>
Pole <tt>type</tt> oznacza rodzaj zapytania:
</p>

<div class="c">
<pre>#define GG_PUBDIR50_WRITE 0x01
#define GG_PUBDIR50_READ 0x02
#define GG_PUBDIR50_SEARCH 0x03</pre>
</div>

<p>
Pole <tt>seq</tt> jest numerek sekwencyjnym zapytania, zwracanym równie¿
w wyniku. Oryginalny klient tworzy go na podstawie aktualnego czasu.
<tt>request</tt> zawiera parametry zapytania. Ilo¶æ jest dowolna. Ka¿dy
parametr jest postaci <tt>"<b>nazwa</b>\0<b>warto¶æ</b>\0"</tt>, tzn.
nazwa od warto¶ci s± oddzielone znakiem o kodzie 0, podobnie jak kolejne
parametry od siebie. Mo¿liwe parametry zapytania to:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_UIN</tt></td><td><tt>FmNumber</tt></td><td>Numer szukanej osoby</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_FIRSTNAME</tt></td><td><tt>firstname</tt></td><td>Imiê</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_LASTNAME</tt></td><td><tt>lastname</tt></td><td>Nazwisko</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_NICKNAME</tt></td><td><tt>nickname</tt></td><td>Pseudonim</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_BIRTHYEAR</tt></td><td><tt>birthyear</tt></td><td>Rok urodzenia. Je¶li chcemy szukaæ osób z danego przedzia³u, podajemy rok pocz±tkowy i koñcowy, oddzielone spacj±. Na przyk³ad ,,<tt>1980 1985</tt>''.</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_CITY</tt></td><td><tt>city</tt></td><td>Miejscowo¶æ</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_GENDER</tt></td><td><tt>gender</tt></td><td>P³eæ. Je¶li szukamy kobiet, ma warto¶æ ,,<tt>1</tt>'' (sta³a <tt>GG_PUBDIR50_GENDER_FEMALE</tt>). Je¶li mê¿czyzn, ma warto¶æ ,,<tt>2</tt>'' (sta³a <tt>GG_PUBDIR50_GENDER_MALE</tt>).</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_START</tt></td><td><tt>ActiveOnly</tt></td><td>Je¶li szukamy tylko dostêpnych osób, ma mieæ warto¶æ ,,<tt>1</tt>'' (sta³a <tt>GG_PUBDIR50_ACTIVE_TRUE</tt>).</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_FAMILYNAME</tt></td><td><tt>familyname</tt></td><td>Nazwisko panieñskie. Ma znaczenie tylko przy ustawianiu w³asnych danych.</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_FAMILYCITY</tt></td><td><tt>familycity</tt></td><td>Miejscowo¶æ pochodzenia. Ma znaczenie tylko przy ustawianiu w³asnych danych.</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_START</tt></td><td><tt>fmstart</tt></td><td>Numer, od którego rozpocz±æ wyszukiwanie. Ma znaczenie, gdy kontynuujemy wyszukiwanie.</td></tr>
</table>

<p>
Tre¶æ przyk³adowego zapytania (pomijaj±c pola <tt>type</tt> i <tt>seq</tt>) znajduje siê poni¿ej. Szukano dostêpnych kobiet o imieniu Ewa z Warszawy. Znaki o kodzie 0 zast±piono kropkami.
</p>

<div class="example">
<pre>firstname.Ewa.city.Warszawa.gender.1.ActiveOnly.1.</pre>
</div>

<p>
Wynik zapytania zostanie zwrócony za pomoc± pakietu:
</p>

<div class="c">
<pre>#define GG_PUBDIR50_REPLY 0x000e
	
struct gg_pubdir50_reply {
	char type;
	int seq;
	char reply[];
};</pre>
</div>

<p>
Pole <tt>type</tt> poza warto¶ciami takimi jak przy pakiecie typu
<tt>GG_PUBDIR50_REQUEST</tt> mo¿e przyj±æ jeszcze warto¶æ oznaczaj±c±
odpowied¼ wyszukiwania:
</p>

<div class="c">
<pre>#define GG_PUBDIR50_SEARCH_REPLY 0x05</pre>
</div>

<p>
Wyniki s± zbudowane identycznie jak w przypadku zapytañ, z t± ró¿nic±, ¿e
kolejne osoby oddzielane pustym polem: <tt>"<b>parametr</b>\0<b>warto¶æ</b>\0\0<b>parametr</b>\0<b>warto¶æ</b>\0"</tt>.
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_STATUS</tt></td><td><tt>FmStatus</tt></td><td>Stan szukanej osoby</td></tr>
<tr class="tabf"><td>&nbsp;</td><td><tt>nextstart</tt></td><td>Pole wystêpuj±ce w ostatnim wyniku, okre¶laj±ce, od jakiego numeru nale¿y rozpocz±æ wyszukiwanie, by otrzymaæ kolejn± porcjê danych. Podaje siê go w zapytaniu jako parametr ,,<tt>start</tt>''.</td></tr>
</table>

<p>
Przyk³adowy wynik zawieraj±cy dwie znalezione osoby:
</p>

<div class="example">
<pre>FmNumber.12345.FmStatus.1.firstname.Adam.nickname.Janek.birthyear.1979.city.Wzdów
..FmNumber.3141592.FmStatus.5.firstname.Ewa.nickname.Ewcia.birthyear.1982.city.Gd
dañsk..nextstart.0.</pre>
</div>

<p>
Wyszukiwanie <b>nie zwraca</b> nazwisk znalezionych osób.
</p>

<hr />

<a name="ch2"></a>
<h2>2. Us³ugi HTTP</h2>

<a name="ch2.1"></a>
<h3>2.1. Format danych</h3>

<p>
Komunikacja z <tt>appmsg.gadu-gadu.pl</tt> metod± <tt>GET</tt> HTTP/1.0
zosta³a opisana w poprzednim rozdziale, pozosta³e pakiety u¿ywaj± 
<tt>POST</tt> dla HTTP/1.0, a w odpowiedzi 1.1. Maj± one postaæ:
</p>

<div class="http">
<pre>POST <b>¦CIE¯KA</b> HTTP/1.0
Host: <b>HOST</b>
Content-Type: application/x-www-form-urlencoded
User-Agent: <b>AGENT</b>
Content-Length: <b>D£UGO¦Æ</b>
Pragma: no-cache

<b>DANE</b></pre>
</div>

<p>
Gdzie <tt><b>AGENT</b></tt> to nazwa przegl±darki (na przyk³ad <tt>Mozilla/4.0
(compatible; MSIE 5.0; Windows 98)</tt> lub inne, wymienione w rozdziale
<a href="#ch1.2">1.2</a>), <tt><b>D£UGO¦Æ</b></tt> to d³ugo¶æ bloku
<tt><b>DANE</b></tt> w znakach.
</p>

<p>
Je¶li bêdzie mowa o wysy³aniu danych do serwera, to chodzi o ca³y powy¿szy
pakiet, opisane zostan± tylko: <tt><b>HOST</b></tt>, <tt><b>¦CIE¯KA</b></tt>
i <tt><b>DANE</b></tt>. Pakiet jest wysy³any na port 80. Gdy mowa o wysy³aniu
pól zapytania, mowa o <tt><b>DANE</b></tt> o warto¶ci:
</p>

<div class="http">
<pre>pole1=warto¶æ1&amp;pole2=warto¶æ2&amp;...</pre>
</div>

<p>
Pamiêtaj o zmianie kodowania na CP1250 i zakodowaniu danych do postaci URL
(na przyk³ad funkcj± typu <tt>urlencode</tt>).
</p>

<p>
Odpowiedzi serwera na powy¿sze zapytania maj± mniej wiêcej postaæ:
</p>

<div class="http">
<pre>HTTP/1.1 200 OK
Server: Microsoft-IIS/5.0
Date: Mon, 01 Jul 2002 22:30:31 GMT
Connection: Keep-Alive
Content-Length: <b>D£UGO¦Æ</b>
Content-Type: text/html
Set-Cookie: <b>COOKIE</b>
Cache-control: private

<b>ODPOWIED¬</b></pre>
</div>

<p>
Nag³ówki nie s± dla nas wa¿ne. Mo¿na zauwa¿yæ tylko to, ¿e czasami serwer
ustawia <tt><b>COOKIE</b></tt> np. ,,<tt>ASPSESSIONIDQQGGGLJC=CAEKMBGDJCFBEOKCELEFCNKH; path=/</tt>''. Pisz±c dalej, ¿e serwer ,,odpowie warto¶ci±'' mo¿na
tylko o polu <b>ODPOWIED¬</b>. Kodowanie znaków w odpowiedzi to CP1250.
</p>

<hr />

<a name="ch2.2"></a>

<h3>2.2. Rejestracja konta</h3>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Pole nag³ówka</b></td><td width="80%"><b>Warto¶æ</b></td></tr>
<tr class="tabf"><td><tt>HOST</tt></td><td><tt>register.gadu-gadu.pl</tt></td></tr>
<tr class="tabf"><td><tt>¦CIE¯KA</tt></td><td><tt>/appsvc/fmregister2.asp</tt></td></tr>
</table>

<p></p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Wysy³amy pole</b></td><td width="80%"><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>pwd</tt></td><td>has³o dla nowego numeru</td></tr>
<tr class="tabf"><td><tt>email</tt></td><td>adres e-mail do przypomnienia has³a</td></tr>
<tr class="tabf"><td><tt>qa</tt></td><td>has³o pomocnicze i odpowied¼, oddzielone znakiem tyldy ,,<tt>~</tt>''</td></tr>
<tr class="tabf"><td><tt>code</tt></td><td>hash liczony z pól <tt>email</tt> i <tt>pwd</tt>. Algorytmu szukaj w ¼ród³ach libgadu w <tt>lib/common.c</tt></td></tr>
</table>

<p>
Dostêpne standardowo pytania pomocnicze i ich aliasy (podawane zamiast
tre¶ci pytania) to:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Alias</b></td><td width="80%"><b>Pytanie</b></td></tr>
<tr class="tabf"><td><tt>1</tt></td><td>Twoja ulubiona potrawa?</td></tr>
<tr class="tabf"><td><tt>2</tt></td><td>Imiê/nazwisko Twojej sympatii z lat szkolnych?</td></tr>
<tr class="tabf"><td><tt>3</tt></td><td>Imiê/nazwisko osoby, z któr± siedzia³e¶ w szkolnej ³awie?</td></tr>
<tr class="tabf"><td><tt>4</tt></td><td>Imiê Twojego dziadka?</td></tr>
<tr class="tabf"><td><tt>5</tt></td><td>Imiê Twojej babci?</td></tr>
<tr class="tabf"><td><tt>6</tt></td><td>Nazwisko panieñskie Twojej matki?</td></tr>
<tr class="tabf"><td><tt>7</tt></td><td>Tytu³ Twojego ulubionego filmu?</td></tr>
<tr class="tabf"><td><tt>8</tt></td><td>Ulubiony aktor?</td></tr>
<tr class="tabf"><td><tt>9</tt></td><td>Ulubiony solista/zespó³ muzyczny?</td></tr>
</table>

<p>
Przyk³ad:
</p>

<div class="http">
<pre>POST /appsvc/fmregister2.asp HTTP/1.0
Host: register.gadu-gadu.pl
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/4.0 (compatible; MSIE 5.0; Windows 98)
Content-Length: 62
Pragma: no-cache
		
pwd=sekret&amp;email=moj@adres.email.pl&amp;qa=5~Maria&amp;code=1104465363</pre>
</div>

<p>
Je¶li wszystko przebieg³o poprawnie, serwer odpowie:
</p>

<div class="http">
<pre>reg_success:<b>UIN</b></pre>
</div>

<p>
Gdzie <tt><b>UIN</b></tt> to nowy numer, który w³a¶nie otrzymali¶my.
</p>

<hr />

<a name="ch2.3"></a>
<h3>2.3. Usuniêcie konta</h3>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Pole nag³ówka</b></td><td width="80%"><b>Warto¶æ</b></td></tr>
<tr class="tabf"><td><tt>HOST</tt></td><td><tt>register.gadu-gadu.pl</tt></td></tr>
<tr class="tabf"><td><tt>¦CIE¯KA</tt></td><td><tt>/appsvc/fmregister2.asp</tt></td></tr>
</table>

<p></p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Wysy³amy pole</b></td><td width="80%"><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>fmnumber</tt></td><td>usuwany numer</td></tr>
<tr class="tabf"><td><tt>fmpwd</tt></td><td>has³o</td></tr>
<tr class="tabf"><td><tt>delete</tt></td><td>warto¶æ ,,<tt>1</tt>''</td></tr>
<tr class="tabf"><td><tt>pwd</tt></td><td>losowa liczba</td></tr>
<tr class="tabf"><td><tt>qa</tt></td><td>pytanie pomocnicza i odpowied¼ (patrz punkt <a href="#ch2.2">2.2</a>)</td></tr>
<tr class="tabf"><td><tt>code</tt></td><td>hash liczony z pola <tt>pwd</tt></td></tr>
</table>

<p>
Przyk³ad:
</p>

<div class="http">
<pre>POST /appsvc/fmregister2.asp HTTP/1.0
Host: register.gadu-gadu.pl
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/4.0 (compatible; MSIE 5.0; Windows 98)
Content-Length: 74
Pragma: no-cache
		
fmnumber=4969256&amp;fmpwd=haslo&amp;delete=1&amp;pwd=%2D388046464&amp;qa=&amp;code=1483497094</pre>
</div>

<p>
Je¶li wszystko przebieg³o poprawnie, serwer odpowie:
</p>

<div class="http">
<pre>reg_success:<b>UIN</b></pre>
</div>

<p>
Gdzie <tt><b>UIN</b></tt> to numer, który skasowali¶my.
</p>

<hr />

<a name="ch2.4"></a>
<h3>2.4. Zmiana has³a</h3>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Pole nag³ówka</b></td><td width="80%"><b>Warto¶æ</b></td></tr>
<tr class="tabf"><td><tt>HOST</tt></td><td><tt>register.gadu-gadu.pl</tt></td></tr>
<tr class="tabf"><td><tt>¦CIE¯KA</tt></td><td><tt>/appsvc/fmregister2.asp</tt></td></tr>
</table>

<p></p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Wysy³amy pole</b></td><td width="80%"><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>fmnumber</tt></td><td>numer</td></tr>
<tr class="tabf"><td><tt>fmpwd</tt></td><td>stare has³o</td></tr>
<tr class="tabf"><td><tt>pwd</tt></td><td>nowe has³o</td></tr>
<tr class="tabf"><td><tt>qa</tt></td><td>pytanie pomocnicze i odpowied¼, patrz punkt <a href="#ch2.2">2.2</a></td></tr>
<tr class="tabf"><td><tt>code</tt></td><td>hash liczony z pola <tt>pwd</tt></td></tr>
</table>

<p>
Je¶li wszystko przebieg³o poprawnie, serwer odpowie:
</p>

<div class="http">
<pre>reg_success:<b>UIN</b></pre>
</div>

<hr />

<a name="ch2.5"></a>
<h3>2.5. Umieszczenie listy kontaktów na serwerze</h3>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Pole nag³ówka</b></td><td width="80%"><b>Warto¶æ</b></td></tr>
<tr class="tabf"><td><tt>HOST</tt></td><td><tt>pubdir.gadu-gadu.pl</tt></td></tr>
<tr class="tabf"><td><tt>¦CIE¯KA</tt></td><td><tt>/appsvc/fmcontactsput.asp</tt></td></tr>
</table>

<p></p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Wysy³amy pole</b></td><td width="80%"><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>FmNum</tt></td><td>numer</td></tr>
<tr class="tabf"><td><tt>Pass</tt></td><td>has³o</td></tr>
<tr class="tabf"><td><tt>Contacts</tt></td><td>dowolna ilo¶æ rekordów z kontaktami rozdzielone znakiem nowej linii ,,<tt>\r\n</tt>''</td></tr>
</table>

<p>
Format pojedynczego kontaktu:
</p>

<div class="c">
<pre>imie;nazwisko;pseudo;wyswietlane;telefon;grupa;uin;adres@email;0;;0;</pre>
</div>

<p>
Ostatnie 3 pola zosta³y dodane w wersji 4.9.3 i s± zwi±zane z d¼wiêkami.
</p>

<p>
Przyk³ad:
</p>

<div class="http">
<pre>POST /appsvc/fmcontactsput.asp HTTP/1.0
Host: pubdir.gadu-gadu.pl
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/4.0 (compatible; MSIE 5.0; Windows 98)
Content-Length: 110
Pragma: no-cache

FmNum=1000&amp;Pass=sekret&amp;Contacts=imie;nazwisko;pseudo;wyswietlane;+48123123123;grup
a1;1000;adres@email.pl;0;;0;</pre>
</div>

<p>
Je¶li siê uda³o, serwer odpowie:
</p>

<div class="http">
<pre>put_success:</pre>
</div>

<hr />

<a name="ch2.6"></a>
<h3>2.6. Pobranie listy kontaktów z serwera</h3>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Pole nag³ówka</b></td><td width="80%"><b>Warto¶æ</b></td></tr>
<tr class="tabf"><td><tt>HOST</tt></td><td><tt>pubdir.gadu-gadu.pl</tt></td></tr>
<tr class="tabf"><td><tt>¦CIE¯KA</tt></td><td><tt>/appsvc/fmcontactsget.asp</tt></td></tr>
</table>

<p></p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Wysy³amy pole</b></td><td width="80%"><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>FmNum</tt></td><td>numer</td></tr>
<tr class="tabf"><td><tt>Pass</tt></td><td>has³o</td></tr>
</table>

<p>
Przyk³ad:
</p>

<div class="http">
<pre>POST /appsvc/fmcontactsget.asp HTTP/1.0
Host: pubdir.gadu-gadu.pl
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/4.0 (compatible; MSIE 5.0; Windows 98)
Content-Length: 22
Pragma: no-cache

FmNum=1000&amp;Pass=sekret</pre>
</div>

<p>
Je¶li siê uda³o, serwer odpowie:
</p>

<div class="http">
<pre>get_results:<b>rekord_1</b>
<b>rekord_2</b>
...
<b>rekord_N</b></pre>
</div>

<p>
Rekord ma taki sam format jak w <a href="#ch2.5">2.5</a>.
</p>

<hr />

<a name="ch2.7"></a>
<h3>2.7. Usuniêcie listy kontaktów z serwera</h3>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Pole nag³ówka</b></td><td width="80%"><b>Warto¶æ</b></td></tr>
<tr class="tabf"><td><tt>HOST</tt></td><td><tt>pubdir.gadu-gadu.pl</tt></td></tr>
<tr class="tabf"><td><tt>¦CIE¯KA</tt></td><td><tt>/appsvc/fmcontactsput.asp</tt></td></tr>
</table>

<p></p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Wysy³amy pole</b></td><td width="80%"><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>FmNum</tt></td><td>numer</td></tr>
<tr class="tabf"><td><tt>Pass</tt></td><td>has³o</td></tr>
<tr class="tabf"><td><tt>Delete</tt></td><td>warto¶æ ,,<tt>1</tt>''</td></tr>
</table>

<p>
Przyk³ad:
</p>

<div class="http">
<pre>POST /appsvc/fmcontactsput.asp HTTP/1.0
Host: pubdir.gadu-gadu.pl
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/4.0 (compatible; MSIE 5.0; Windows 98)
Content-Length: 31
Pragma: no-cache

FmNum=1000&amp;Pass=sekret&amp;Delete=1</pre>
</div>

<p>
Je¶li siê uda³o, serwer odpowie:
</p>

<div class="http">
<pre>put_success:</pre>
</div>

<hr />

<a name="ch2.8"></a>
<h3>2.8. Przypomnienie has³a poczt±</h3>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Pole nag³ówka</b></td><td width="80%"><b>Warto¶æ</b></td></tr>
<tr class="tabf"><td><tt>HOST</tt></td><td><tt>retr.gadu-gadu.pl</tt></td></tr>
<tr class="tabf"><td><tt>¦CIE¯KA</tt></td><td><tt>/appsvc/fmsendpwd.asp</tt></td></tr>
</table>

<p></p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Wysy³amy pole</b></td><td width="80%"><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>userid</tt></td><td>numer</td></tr>
<tr class="tabf"><td><tt>code</tt></td><td>hash liczony z pola <tt>userid</tt></td></tr>
</table>

<p>
Je¶li siê uda³o, serwer odpowie:
</p>

<div class="http">
<pre>pwdsend_success</pre>
</div>

<hr />

<a name="ch3"></a>
<h2>3. Bezpo¶rednie po³±czenia</h2>

<pre>Author: Walerian Soko³owski (C) Copyright 2002
You a free to change it in every way you want.

----- (0) disclaimer ------------------------------
Opisujê tu protokó³ przesy³ania plików w miêdzy klientami G*du-G*du.
Informacjê czerpa³em ze ¼róde³ gglib w której¶ z wersji
oraz z do¶wiadczeñ przeprowadzanych w³asnorêcznie. W tym celu nic nie 
desasemblowa³em i nie reingenerowa³em.

----- 1) zamiast wstêpu ------------------------------------------------------
Protokó³ jest pewn± implementacj± czê¶ci powszechnie znanego DCC 
opisanego w którym¶ z RFC. 

Obowi±zuj± naturalne dla GG ustalenia, a wiêc sizeof(int) = 4 oraz transmisja
jest intel endian. 

----- 2) nawi±zanie po³±czenia ------------------------------------------------
Klient ³±cz±c siê z serwerem GG wysy³a swój adres IP i port, na którym
nas³uchuje (patrz opis gg_login). Gdy który¶ z kontaktów staje siê 
dostêpny (w³a¶nie siê po³±czyli¶my lub on w³a¶nie zmieni³ stan) 
otrzymujemu powiadomienie o tym w paczce typu GG_NOTIFY_REPLY, 
która zawiera jego adresek IP i port, na którym on nas³uchuje (patrz
opis gg_notify_reply). Tak wiêc w najprostszej sytuacji, gdy nie dziel±
nas ¿adne firewalle strona wysy³aj±ca ma adres odbiorcy.
 
Je¶li odbiorca znajduje siê za firewallem, a nadawca nie, to nadawca
mo¿e poprosiæ odbiorcê o nawi±zanie po³±czenia wysy³aj±c do niego
komunikat typu 0x0010 (GG_CLASS_CTCP) o zawarto¶ci 0x02. W taki sposób
na czas nawi±zania po³±czenia nadawca i odbiorca zamieniaj± siê rolami.
I do koñca punktu bêdê ich nazywaæ wg. pe³nionych ról.

A wiêc nadawca nawi±zuje po³±czenie TCP z adresem odbiorcy i wysy³a
swój UIN i UIN odbiorcy:

	struct {
		int uin1; /* mój numerek  */
		int uin2; /* jego numerek */
	};

Odbiorca potwierdzaj±c nawi±zanie po³±czenia z klientem GG wysy³a 4 bajty:
 
	struct {
		char [] "UDAG";
	};

Je¶li nadawca ma wysy³aæ plik, to wysy³a 0x0002:
 
	#define GG_DCC_CATCH_FILE 0x0002

Je¶li to odbiorca ma wysy³aæ, to nadawca wysy³a 0x0003:
	
	#define GG_DCC_WANT_FILE 0x0003

Po tym wszystkim uwa¿a siê po³±czenie za nawi±zane.

----- 3) transmisja pliku: strona nadawcy -------------------------------------
Nadawca wysy³a  po kolei:

	#define GG_DCC_HAVE_FILE     0x0001
	#define GG_DCC_HAVE_FILEINFO 0x0003
	int dunno1; /* 0 */
	int dunno2; /* 0 */
	file_info_struct finfo;

Podejrzewam, ¿e dunno2:dunno1 jest pozycj± w pliku, od której nadawca 
chce wysy³aæ plik, ale nie uda³o mi siê zasymulowaæ sytuacji, w której 
by³yby u¿ywane.

	struct file_info_struct {
        	int mode;                  /* dwFileAttributes */
        	int ctime[2];              /* ftCreationTime */
        	int atime[2];              /* ftLastAccessTime */
        	int mtime[2];              /* ftLastWriteTime */
		int size_hdw;              /* górne 4 bajty d³ugo¶ci pliku */
		int size_ldw;              /* dolne 4 bajty d³ugo¶ci pliku */
		int reserved1;             /* 0 */
		int reserved2;             /* 0 */
		char file_name[276];       /* tablica zaczynaj±ca siê od nazwy 
					      pliku, wype³niona zerami */
	};

Dalej nadawca czeka na akceptacjê odbiorcy, czyli nastêpuj±c± strukturkê:
	
	struct {
		int type;      /* 0x0006 GG_DCC_GIMME_FILE */
		int start;     /* od której pozycji zacz±æ przesy³anie */
		int dunno;     /* 0 */
	};

Teraz mo¿emy zacz±æ przesy³anie pliku. Plik przesy³amy w paczkach d³ugo¶ci 
ustalonej przez nadawcê. Przed ka¿d± paczk± z danymi nadawca wysy³a nag³ówek
paczki:
	struct {
		int type;       /* 0x0003 GG_DCC_FILEHEADER, je¶li paczka nie 
				   jest ostatnia. 0x0002 GG_DCC_LAST_FILEHEADER
				   wpp. */
		int chunk_size; /* rozmiar paczki */
		int dunno;      /* 0 */
	};

Po wys³aniu ostatniej paczki zamykamy po³±czenie. Plik zosta³ przes³any.

----- 4) transmisja pliku: strona odbiorcy ------------------------------------
Zachowanie odbiorcy jest symetryczne:
1. odbiera kolejno 
	GG_DCC_HAVE_FILE
	GG_DCC_HAVE_FILEINFO
	int dunno1;
	int dunno2;
	file_info_struct finfo;

2. je¶li u¿ytkownik zgodzi siê odebraæ plik, to wysy³amy struktrê jakiej
odbiorca siê spodziewa.

3. otrzymujemy nag³ówek paczki i paczkê z danymi zadeklarowanej d³ugo¶ci
4. je¶li nag³ówek by³ typu GG_DCC_LAST_FILEHEADER to otrzymali¶my ca³o¶æ, 
wiêc zamykamy po³±czenie. Je¶li nie, to wracamy do kroku 3.
</pre>

<hr />

<a name="ch4"></a>
<h2>4. Autorzy</h2>

<p>
Autorami powy¿szego opisu s±:
</p>

<ul>
	<li><b>Wojtek Kaniewski</b> (wojtekka%irc.pl): pierwsza wersja opisu, poprawki, utrzymanie wszystkiego w porz±dku.</li>
	<li><b>Robert J. Wo¼ny</b> (speedy%atman.pl): opis nowo¶ci w protokole GG 4.6, poprawki.</li>
	<li><b>Tomasz Jarzynka</b> (tomee%cpi.pl): badanie timeoutów.</li>
	<li><b>Adam Ludwikowski</b> (adam.ludwikowski%wp.pl): wiele poprawek, wersje klientów, rozszerzone wiadomo¶ci, powody nieobecno¶ci.</li>
	<li><b>Marek Kozina</b> (klith%hybrid.art.pl): czas otrzymania wiadomo¶ci.</li>
	<li><b>Rafa³ Florek</b> (raf%regionet.regionet.pl): opis po³±czeñ konferencyjnych.</li>
	<li><b>Igor Popik</b> (igipop%wsfiz.edu.pl): klasy wiadomo¶ci przy odbieraniu zakolejkowanej.</li>
	<li><b>Rafa³ Cyran</b> (ajron%wp.pl): informacje o remote_port, rodzaje potwierdzeñ przy ctcp, GG_LOGIN_EXT.</li>
	<li><b>Piotr Mach</b> (pm%gadu-gadu.com): ilo¶æ kontaktów, pe³na skrzynka, pusta lista, maska audio, us³ugi HTTP, GG_LOGIN_EXT.</li>
	<li><b>Adam Czy¶ciak</b> (acc%interia.pl): potwierdzenie wiadomo¶ci GG_CLASS_ACK.</li>
	<li><b>Kamil Dêbski</b> (kdebski%kki.net.pl): czas w stanach opisowych.</li>
	<li><b>Pawe³ Piwowar</b> (alfapawel%go2.pl): format czasu.</li>
	<li><b>Tomasz Chiliñski</b> (chilek%chilan.com): nowo¶ci w 5.0.2.</li>
	<li><b>Rados³aw Nowak</b> (rano%ranosoft.com): uzupe³nienie statusu opisowego, wersja 5.0.3.</li>
	<li><b>Walerian Soko³owski</b>: opis protoko³u bezpo¶rednich po³±czeñ.</li>
</ul>

<hr />

<font color="silver">
$Id$
</font>

</td></tr></table>
</center>

</body>
</html>
